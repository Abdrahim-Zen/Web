<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestione Prodotti - Tecnico</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <#include "header.ftl.html">
        <h1>Gestione Richieste in Carico</h1>
        
        <!-- Debug info - CON CONTROLLO DI SICUREZZA -->
        <div class="alert alert-info">
            Numero richieste: <#if richiesteInCarico??>${richiesteInCarico?size}<#else>0</#if>
        </div>

        <!-- Messaggi di errore -->
        <#if error??>
            <div class="alert alert-danger">
                ${error}
            </div>
        </#if>

        <!-- Messaggi dalle request parameters -->
        <#if RequestParameters??>
            <#if RequestParameters.success??>
                <div class="alert alert-success">
                    Prodotto proposto con successo!
                </div>
            </#if>
            <#if RequestParameters.error??>
                <div class="alert alert-danger">
                    <#if RequestParameters.error == "1">
                        Errore nei dati inseriti.
                    <#elseif RequestParameters.error == "2">
                        Errore durante la proposta del prodotto.
                    </#if>
                </div>
            </#if>
        </#if>

        <!-- CONTROLLO PRINCIPALE CON ?? E has_content -->
        <#if richiesteInCarico?? && richiesteInCarico?has_content>
            <#list richiesteInCarico as richiesta>
                <div class="card mb-4">
                    <div class="card-header">
                        <h5>Richiesta #${richiesta.richiestaKey!''}</h5>
                        <small>In Carico dal: ${(richiesta.dataIncarico?string('dd/MM/yyyy HH:mm'))!''}</small>
                    </div>
                    
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>Note:</strong> ${richiesta.noteRichiesta!''}</p>
                                <p><strong>Importo:</strong> €${richiesta.importoTotale!''}</p>
                                <p><strong>Categoria:</strong> ${richiesta.categoriaNome!''}</p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>Cliente:</strong> ${richiesta.utenteNome!''} ${richiesta.utenteCognome!''}</p>
                            </div>
                        </div>
                          <#assign specificheKey = "specificheRichiesta_" + richiesta.key>
                        <#if .data_model[specificheKey]??>
                            <#assign specificheRichiesta = .data_model[specificheKey]>
                            <#if specificheRichiesta?has_content>
                                <div class="mt-3">
                                    <h6>Specifiche richieste:</h6>
                                    <div class="table-responsive">
                                        <table class="table table-sm table-bordered">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>Caratteristica</th>
                                                    <th>Valore Richiesto</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <#list specificheRichiesta as spec>
                                                <tr>
                                                    <td>${spec.nome_specifica!''}</td>
                                                    <td>${spec.valore!''}</td>
                                                </tr>
                                                </#list>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </#if>
                        </#if>

                        <!-- Prodotti già proposti - CON CONTROLLO SICURO -->
                        <#assign prodottiKey = "prodottiRichiesta_" + richiesta.key>
                        <#if .data_model[prodottiKey]??>
                            <#assign prodottiProposti = .data_model[prodottiKey]>
                            <#if prodottiProposti?has_content>
                                <h6>Prodotti proposti:</h6>
                                <#list prodottiProposti as prodotto>
                                    <div class="card mb-2">
                                        <div class="card-body">
                                            <h6>${prodotto.nome!''}</h6>
                                            <p>${prodotto.descrizione!''}</p>
                                            <p><strong>Prezzo:</strong> €${prodotto.prezzo!''}</p>
                                            <small>Proposto il: ${(prodotto.dataProposta?string('dd/MM/yyyy HH:mm'))!''}</small>
                                        </div>
                                    </div>
                                </#list>
                            </#if>
                        </#if>

                        <!-- Form Proposta Prodotto -->
                        <form action="gestioneProdotti" method="post" class="mt-3">
                            <input type="hidden" name="action" value="proponiProdotto">
                            <input type="hidden" name="idRichiestaInCarico" value="${richiesta.key!''}">
                        
                            
                            <div class="mb-3">
                                <label class="form-label">Nome Prodotto</label>
                                <input type="text" class="form-control" name="nomeProdotto" required>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Prezzo (€)</label>
                                <input type="number" class="form-control" name="prezzoProdotto" step="0.01" min="0.01" required>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Descrizione</label>
                                <textarea class="form-control" name="descrizioneProdotto" rows="3" required></textarea>
                            </div>
                            
                            <button type="submit" class="btn btn-success">Proponi Prodotto</button>
                        </form>
                    </div>
                </div>
            </#list>
        <#else>
            <div class="alert alert-warning">
                Nessuna richiesta in carico al momento.
            </div>
        </#if>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Validazione semplice
        document.addEventListener('DOMContentLoaded', function() {
            const forms = document.querySelectorAll('form');
            forms.forEach(form => {
                form.addEventListener('submit', function(e) {
                    const prezzo = form.querySelector('input[name="prezzoProdotto"]');
                    const nome = form.querySelector('input[name="nomeProdotto"]');
                    const descrizione = form.querySelector('textarea[name="descrizioneProdotto"]');
                    
                    let isValid = true;
                    
                    if (prezzo && parseFloat(prezzo.value) <= 0) {
                        isValid = false;
                        alert('Il prezzo deve essere maggiore di 0');
                        prezzo.focus();
                    }
                    
                    if (nome && nome.value.trim() === '') {
                        isValid = false;
                        alert('Il nome del prodotto è obbligatorio');
                        nome.focus();
                    }
                    
                    if (descrizione && descrizione.value.trim() === '') {
                        isValid = false;
                        alert('La descrizione è obbligatoria');
                        descrizione.focus();
                    }
                    
                    if (!isValid) {
                        e.preventDefault();
                    }
                });
            });
        });
    </script>
</body>
</html>