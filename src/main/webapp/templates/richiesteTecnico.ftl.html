<!DOCTYPE html>
<html>
    <head>
        <title>Richieste di Acquisto</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <#include "head.html">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    </head>
    <body>
        <div class="container mt-4">
            <#include "header.ftl.html">
            
            <#if RequestParameters??>
                <#if RequestParameters.success??>
                    <div class="alert alert-success">
                        Richiesta accettata con successo!
                    </div>
                </#if>
                <#if RequestParameters.error??>
                    <div class="alert alert-danger">
                        <#if RequestParameters.error == "1">
                            Errore nell'accettazione della richiesta.
                        <#elseif RequestParameters.error == "2">
                            Richiesta già assegnata.
                        </#if>
                    </div>
                </#if>
            </#if>

            <h2>Richieste di acquisto disponibili</h2>
            
            <#if lista?? && lista?size gt 0>
                <div class="table-responsive">
                    <table class="table table-striped table-bordered">
                        <thead class="table-dark">
                            <tr>
                                <th>Categoria</th>
                                <th>Note</th>
                                <th>Importo Totale</th>
                                <th>Stato</th>
                                <th>Data Inserimento</th>
                                <th>Azioni</th>
                            </tr>
                        </thead>
                        <tbody>
                            <#list lista as r>
                            <tr>
                                <td>${r.categoria.nomeCategoria!""}</td>
                                <td>${r.note!""}</td>
                                <td>€${r.importo!""}</td>
                                <td>
                                    <span class="badge 
                                        <#if r.stato == 'in_attesa'>bg-warning
                                        <#elseif r.stato == 'in_valutazione'>bg-info
                                        <#elseif r.stato == 'approvata'>bg-success
                                        <#elseif r.stato == 'rifiutata'>bg-danger
                                        <#else>bg-secondary
                                        </#if>">
                                        ${r.stato}
                                    </span>
                                </td>
                                <td>${r.dataInserimento?string("dd/MM/yyyy HH:mm")}</td>
                                <td>
                                    <#if r.stato == 'in_attesa'>
                                    <!-- CORREZIONE: action deve puntare a richiesteTecnico e aggiungere il parametro action -->
                                    <form action="richiesteTecnico" method="post" style="display: inline;">
                                        <input type="hidden" name="action" value="accettaRichiesta">
                                        <input type="hidden" name="idRichiesta" value="${r.key}">
                                        <button type="submit" class="btn btn-success btn-sm">
                                            Accetta
                                        </button>
                                    </form>
                                    <#else>
                                    <span class="text-muted">Già gestita</span>
                                    </#if>
                                </td>
                            </tr>
                            </#list>
                        </tbody>
                    </table>
                </div>
            <#else>
                <div class="alert alert-info">
                    Nessuna richiesta di acquisto disponibile al momento.
                </div>
            </#if>
        </div>
        
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    </body>
</html>